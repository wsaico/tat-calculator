<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>TAT Monitor Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; overflow-x: hidden; font-family: system-ui, -apple-system, sans-serif; }
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        :root{
            --primary:#163071; /* azul primario */
            --secondary:#8DBB36; /* verde secundario */
            /* neutrales suaves para evitar tonos celestes */
            --soft-primary-bg:#F4F6FA;
            --soft-primary-border:#D6DCE8;
            --soft-secondary-bg:#EFF6E6;
            --soft-secondary-border:#D1E5A6;
            --soft-red-bg:#FDEAEA;
            --soft-red-border:#FAC5C5;
            --red:#D12B2B;
            /* paleta naranja suave para estados de progreso */
            --orange:#f97316;
            --soft-orange-bg:#fff7ed; /* orange-50 */
            --soft-orange-border:#fed7aa; /* orange-200 */
        }
        .btn-secondary{ background-color: var(--secondary); color:#fff; }
        .btn-secondary:active{ background-color:#6d9a28; }
        .bg-soft-secondary{ background-color: var(--soft-secondary-bg); }
        .bg-soft-red{ background-color: var(--soft-red-bg); }
        .border-l-secondary{ border-left-color: var(--secondary); }
        .border-l-red{ border-left-color: var(--red); }
        .header-brand-bg{ background-color: var(--primary); }
        .btn-primary{ background-color: var(--primary); color:#fff; }
        .btn-primary:active{ background-color:#0f2454; }
        .input-primary{ background-color:#FFFFFF; border:1px solid var(--soft-primary-border); color:var(--primary); }
        .input-secondary{ background-color: var(--soft-secondary-bg); border:1px solid var(--soft-secondary-border); color:#335e11; }
        .card-ok{ background-color: var(--secondary); }
        /* Tarjeta del reloj con efecto LED verde, sin cambiar tamaño */
        .card-clock{ background: linear-gradient(135deg,#0b1221,#0f1b35); position:relative; box-shadow: inset 0 0 0 1px rgba(141,187,54,.35), 0 0 10px rgba(141,187,54,.25); }
        .card-clock::before{ content:""; position:absolute; inset:0; background-image: radial-gradient(circle at 8px 8px, rgba(141,187,54,.10) 0 2px, transparent 2.8px); background-size: 18px 18px; opacity:.35; pointer-events:none; border-radius: inherit; }
        .card-late{ background-color: var(--red); }
        .card-neutral{ background-color: var(--primary); }
        .badge-ok{ background-color: var(--soft-secondary-bg); color:#3C5F1C; border:1px solid var(--soft-secondary-border); }
        .badge-plan{ background-color: var(--soft-primary-bg); color:#475569; border:1px solid var(--soft-primary-border); }
        .badge-late{ background-color: var(--soft-red-bg); color:#8B1C1C; border:1px solid var(--soft-red-border); }
        .badge-progress{ background-color: var(--soft-orange-bg); color:#c2410c; border:1px solid var(--soft-orange-border); }
        .diff-badge{ padding:2px 6px; border-radius:6px; font-weight:700; }
        .diff-ok{ background-color: var(--soft-secondary-bg); color:#3C5F1C; border:1px solid var(--soft-secondary-border); }
        .diff-late{ background-color: var(--soft-red-bg); color:#8B1C1C; border:1px solid var(--soft-red-border); }
        .minute-pill{ background-color: var(--soft-orange-bg); color:#b45309; border:1px solid var(--soft-orange-border); border-radius:6px; padding:2px 6px; font-weight:800; font-size:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .digital-clock{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; letter-spacing:1px; }
        .digital-clock .colon{ animation: blinkColon 1s steps(2, start) infinite; }
        @keyframes blinkColon{ 50%{ opacity: .35 } }
        /* Animación de pulso para items en progreso */
        @keyframes pulseSecondary {
            0% { box-shadow: 0 0 0 0 rgba(141,187,54,0.35); }
            70% { box-shadow: 0 0 0 10px rgba(141,187,54,0.0); }
            100% { box-shadow: 0 0 0 0 rgba(141,187,54,0.0); }
        }
        .pulse { animation: pulseSecondary 1.8s ease-out infinite; }
        /* Indicador llamativo de progreso */
        @keyframes spin360 { from { transform: rotate(0deg) } to { transform: rotate(360deg) } }
        .spinner { width: 14px; height: 14px; border-radius: 9999px; border: 2px solid rgba(141,187,54,.35); border-top-color: var(--secondary); display:inline-block; animation: spin360 1s linear infinite; }
        .progress-track { position: relative; height: 6px; border-radius: 8px; background: rgba(141,187,54,.15); border: 1px solid rgba(141,187,54,.35); overflow: hidden; }
        @keyframes slideStripes { from { background-position: 0 0 } to { background-position: 30px 0 } }
        .progress-indicator { position:absolute; inset:0; background-image: repeating-linear-gradient(45deg, rgba(141,187,54,.6) 0 10px, rgba(141,187,54,.2) 10px 20px); animation: slideStripes .6s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Iconos SVG simplificados
        const Icon = ({ type, className = "w-5 h-5" }) => {
            const paths = {
                plane: "M2.5 19h19v2h-19v-2zm19.57-9.36c-.21-.8-1.04-1.28-1.84-1.06L14.92 10l-6.9-6.43-1.93.51 4.14 7.17-4.97 1.33-1.97-1.54-1.45.39 2.59 4.49L21 11.49c.81-.23 1.28-1.05 1.07-1.85z",
                camera: "M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
                clock: "M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm1-13h-2v6l5.2 3.2.8-1.3-4-2.4V7z",
                alert: "M12 2L1 21h22L12 2zm0 6l7.5 13h-15L12 8zm-1 9h2v2h-2v-2zm0-6h2v4h-2v-4z",
                check: "M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z",
                zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
                edit: "M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
            };
            return <svg className={className} viewBox="0 0 24 24" fill="currentColor"><path d={paths[type]} /></svg>;
        };

        const TATCalculator = () => {
            const [motorCutTime, setMotorCutTime] = useState('');
            const [itineraryMotorCutTime, setItineraryMotorCutTime] = useState('');
            const [etdTime, setETDTime] = useState('');
            const [aircraftType, setAircraftType] = useState('remolque');
            const [showItinerary, setShowItinerary] = useState(false);
            const [realTimes, setRealTimes] = useState({});
            const [currentTime, setCurrentTime] = useState(new Date());
            const [showSummary, setShowSummary] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const summaryRef = useRef(null);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const getCurrentTimeString = () => {
                return `${String(currentTime.getHours()).padStart(2, '0')}:${String(currentTime.getMinutes()).padStart(2, '0')}`;
            };

            // Utilidades para entrada de tiempo en 24h (HH:MM)
            const isValidHHMM = (s) => /^([01]\d|2[0-3]):([0-5]\d)$/.test(s);
            const formatTimeInput = (value) => {
                const digits = String(value).replace(/[^0-9]/g, '');
                if (digits.length <= 2) return digits;
                const hh = digits.slice(0, 2);
                const mm = digits.slice(2, 4);
                return mm ? `${hh}:${mm}` : hh;
            };

            const processConfig = {
                remolque: {
                    tatTotal: 35,
                    processes: [
                        { id: 'motorCut', name: 'Corte Motor', offset: -35, critical: true, highlight: false },
                        { id: 'doorsOpen', name: 'Apertura Puertas', offset: -33 },
                        { id: 'disembarkEnd', name: 'Fin Desembarque', offset: -25 },
                        { id: 'cleanStart', name: 'Inicio Limpieza', offset: -25 },
                        { id: 'cleanEnd', name: 'Fin Limpieza', offset: -21 },
                        { id: 'preBoard', name: 'Pre-Embarque', offset: -27 },
                        { id: 'boardingCall', name: 'Embarque Sala', offset: -23 },
                        { id: 'baggageSearch', name: 'Búsqueda Equipaje', offset: -14 },
                        { id: 'flightDelivery', name: 'Entrega de Vuelo', offset: -12, critical: true, highlight: true },
                        { id: 'lastPax', name: 'Último Pasajero', offset: -10, critical: true },
                        { id: 'accommodation', name: 'Acomodación PAX', offset: -7 },
                        { id: 'doorsClosed', name: 'Cierre de Puertas', offset: -7, critical: true, highlight: true },
                        { id: 'engineStart', name: 'Encendido Motor', offset: -7 },
                        { id: 'pushBack', name: 'Push Back', offset: 0, critical: true },
                        { id: 'etd', name: 'ETD', offset: 0, critical: true, highlight: false }
                    ]
                },
                autopropulsado: {
                    tatTotal: 40,
                    processes: [
                        { id: 'motorCut', name: 'Corte Motor', offset: -40, critical: true, highlight: false },
                        { id: 'doorsOpen', name: 'Apertura Puertas', offset: -38 },
                        { id: 'disembarkEnd', name: 'Fin Desembarque', offset: -30 },
                        { id: 'cleanStart', name: 'Inicio Limpieza', offset: -30 },
                        { id: 'cleanEnd', name: 'Fin Limpieza', offset: -26 },
                        { id: 'preBoard', name: 'Pre-Embarque', offset: -32 },
                        { id: 'boardingCall', name: 'Embarque Sala', offset: -28 },
                        { id: 'baggageSearch', name: 'Búsqueda Equipaje', offset: -19 },
                        { id: 'flightDelivery', name: 'Entrega de Vuelo', offset: -17, critical: true, highlight: true },
                        { id: 'lastPax', name: 'Último Pasajero', offset: -15, critical: true },
                        { id: 'accommodation', name: 'Acomodación PAX', offset: -12 },
                        { id: 'doorsClosed', name: 'Cierre de Puertas', offset: -12, critical: true, highlight: true },
                        { id: 'engineStart', name: 'Encendido Motor', offset: -12 },
                        { id: 'pushBack', name: 'Push Back', offset: -5, critical: true },
                        { id: 'etd', name: 'ETD', offset: 0, critical: true, highlight: false }
                    ]
                }
            };

            const config = processConfig[aircraftType];

            const timeToMinutes = (timeStr) => {
                if (!timeStr || !isValidHHMM(timeStr)) return 0;
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };

            const minutesToTime = (mins) => {
                const h = Math.floor(mins / 60);
                const m = Math.floor(mins % 60);
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };

            const getPlannedTime = (process) => {
                if (process.id === 'motorCut') return isValidHHMM(motorCutTime) ? motorCutTime : null;
                if (process.id === 'etd') return isValidHHMM(etdTime) ? etdTime : null;
                if (!motorCutTime || !isValidHHMM(motorCutTime)) return null;
                const motorMins = timeToMinutes(motorCutTime);
                const offsetFromMotor = config.tatTotal + process.offset;
                return minutesToTime(motorMins + offsetFromMotor);
            };

            // Itinerario Comercial: anclado al "Corte Motor Itinerario" editable
            const getItineraryTime = (process) => {
                if (process.id === 'motorCut') return isValidHHMM(itineraryMotorCutTime) ? itineraryMotorCutTime : null;
                if (process.id === 'etd') return isValidHHMM(etdTime) ? etdTime : null;
                if (!itineraryMotorCutTime || !isValidHHMM(itineraryMotorCutTime)) return null;
                const itinMotorMins = timeToMinutes(itineraryMotorCutTime);
                const offsetFromMotor = config.tatTotal + process.offset;
                return minutesToTime(itinMotorMins + offsetFromMotor);
            };

            const getTimeDiff = (planned, real) => {
                if (!real || !planned) return 0;
                return timeToMinutes(real) - timeToMinutes(planned);
            };

            const analyzeAllProcesses = () => {
                const currentMins = currentTime.getHours() * 60 + currentTime.getMinutes();
                // Primer pase: calcular datos base
                const base = config.processes.map(process => {
                    const planned = getPlannedTime(process);
                    const itinerary = getItineraryTime(process);
                    const real = realTimes[process.id];
                    const diff = real ? getTimeDiff(planned, real) : null;
                    const plannedMins = planned ? timeToMinutes(planned) : null;
                    const isConfigured = Boolean(motorCutTime);
                    let status;
                    if (real) {
                        status = diff > 0 ? 'late' : 'ok';
                    } else {
                        status = (!isConfigured || plannedMins === null) ? 'setup' : 'planned';
                    }
                    return { process, planned, itinerary, real, diff, plannedMins, status };
                });

                // Seleccionar un único proceso "en progreso" según el tiempo actual
                // Regla: si hay procesos pendientes con plan <= ahora, elegir el último de esos (activo).
                // Si no hay, elegir el próximo si está a <= 5 minutos.
                const candidates = base.filter(b => !b.real && b.plannedMins !== null);
                let selectedId = null;
                const pastOrNow = candidates
                    .filter(b => b.plannedMins <= currentMins)
                    .sort((a,b) => a.plannedMins - b.plannedMins);
                if (pastOrNow.length > 0) {
                    selectedId = pastOrNow[pastOrNow.length - 1].process.id;
                } else {
                    const ahead = candidates
                        .filter(b => b.plannedMins > currentMins)
                        .sort((a,b) => a.plannedMins - b.plannedMins);
                    if (ahead.length && (ahead[0].plannedMins - currentMins) <= 5) {
                        selectedId = ahead[0].process.id;
                    }
                }
                const enableProgress = Boolean(selectedId);

                // Segundo pase: devolver estructura final con inProgress marcado solo para el seleccionado
                return base.map(b => ({
                    ...b.process,
                    planned: b.planned,
                    itinerary: b.itinerary,
                    real: b.real,
                    diff: b.diff,
                    status: b.status,
                    inProgress: enableProgress && b.process.id === selectedId
                }));
            };

            const calculateActualTAT = () => {
                if (!motorCutTime || !isValidHHMM(motorCutTime)) return null;
                const endId = aircraftType === 'autopropulsado' ? 'etd' : 'pushBack';
                const endProcess = config.processes.find(p => p.id === endId);
                const plannedEnd = endProcess ? getPlannedTime(endProcess) : null;
                const realEnd = realTimes[endId] || null;
                const endTime = (realEnd && isValidHHMM(realEnd)) ? realEnd : plannedEnd;
                if (!endTime) return null;
                return timeToMinutes(endTime) - timeToMinutes(motorCutTime);
            };

            const allProcesses = analyzeAllProcesses();
            const delays = allProcesses.filter(p => p.status === 'late');
            const improvements = allProcesses.filter(p => p.real && p.diff !== null && p.diff < 0);
            const bestImprovement = improvements.length
                ? improvements.reduce((best, p) => (best === null || p.diff < best.diff ? p : best), null)
                : null;
            const worstDelay = delays.length
                ? delays.reduce((worst, p) => (worst === null || p.diff > worst.diff ? p : worst), null)
                : null;
            const completed = allProcesses.filter(p => p.real).length;
            const actualTAT = calculateActualTAT();
            const tatTarget = config.tatTotal;
            const tatDiff = actualTAT !== null ? (actualTAT - tatTarget) : 0;
                const tatCardClass = actualTAT === null ? 'card-neutral' : (tatDiff > 0 ? 'card-late' : 'card-ok');

            const captureTime = (processId) => {
                setRealTimes(prev => ({ ...prev, [processId]: getCurrentTimeString() }));
            };

            // Método de captura de pantalla eliminado: solo se mantiene el resumen HTML

            const generateHtmlSummary = () => {
                const statusText = (s) => (
                    s === 'ok' ? 'A tiempo' :
                    s === 'late' ? 'Fuera de tiempo' :
                    s === 'planned' ? 'Planificado' :
                    'Planificar'
                );
                const nowStr = new Date().toLocaleString('es-PE', { hour12: false });
                const delaysSorted = [...delays].sort((a, b) => b.diff - a.diff);
                const complianceText = actualTAT !== null ? (tatDiff > 0 ? `Fuera de tiempo +${tatDiff}'` : 'OK') : '--';
                const isLate = actualTAT !== null && tatDiff > 0;

                const html = `<!DOCTYPE html>
<html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resumen TAT</title>
<style>
  :root{
    --primary:#0f172a; /* slate-900 */
    --secondary:#8DBB36; /* verde ejecutivo */
    --neutral:#f1f5f9; /* slate-100 */
    --soft:#ffffff;
    --red:#dc2626;
    --orange:#f97316;
    --border:#cbd5e1;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,sans-serif;margin:0;background:#fff;color:#0f172a}
  .header{background:var(--primary);color:#fff;padding:16px 20px;border-bottom:4px solid var(--secondary)}
  .title{margin:0;font-weight:900;font-size:18px}
  .meta{margin-top:4px;font-size:12px;opacity:.85}
  .container{padding:18px 20px}
  .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-bottom:14px}
  .kpi{border-radius:12px;padding:12px;color:#fff}
  .kpi .label{font-size:12px;opacity:.85;font-weight:800}
  .kpi .value{font-size:20px;font-weight:900}
  .kpi.ok{background:var(--secondary)}
  .kpi.neutral{background:#334155}
  .kpi.late{background:var(--red)}
  .kpi.orange{background:var(--orange)}
  .section-title{font-size:13px;font-weight:900;margin:14px 0 8px;color:#0f172a}
  table{width:100%;border-collapse:collapse;font-size:12px}
  thead th{background:var(--neutral);text-align:left}
  th,td{border:1px solid var(--border);padding:8px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-weight:700}
  .badge{display:inline-block;padding:3px 8px;border-radius:9999px;font-weight:800;font-size:11px;border:1px solid}
  .badge-ok{background:rgba(141,187,54,.12);color:var(--secondary);border-color:rgba(141,187,54,.35)}
  .badge-late{background:#fef2f2;color:#b91c1c;border-color:#fecaca}
  .badge-plan{background:#f8fafc;color:#334155;border-color:#cbd5e1}
  .badge-progress{background:#fff7ed;color:#c2410c;border-color:#fed7aa}
  .delays{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .delay-card{border:1px solid #fecaca;border-radius:12px;background:#fef2f2;color:#b91c1c;padding:10px}
  .delay-card.crit{background:var(--red);color:#fff;border:0}
  @media (max-width:720px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media print{.header{border:0} .kpi{break-inside:avoid} .delay-card{break-inside:avoid}}
</style></head>
<body>
  <div class="header">
    <h1 class="title">RESUMEN TAT</h1>
    <div class="meta">${nowStr} · Tipo: ${aircraftType === 'remolque' ? 'Remolque' : 'Autopropulsado'} · Itinerario: ${showItinerary ? 'ON' : 'OFF'}</div>
  </div>
  <div class="container">
    <div class="kpis">
      <div class="kpi ${actualTAT === null ? 'neutral' : (isLate ? 'late' : 'ok')}">
        <div class="label">TAT</div>
        <div class="value">${actualTAT !== null ? `${actualTAT}'` : `--'`} / ${tatTarget}'</div>
      </div>
      <div class="kpi ${isLate ? 'late' : 'ok'}">
        <div class="label">Cumplimiento</div>
        <div class="value">${complianceText}</div>
      </div>
      <div class="kpi neutral">
        <div class="label">Progreso</div>
        <div class="value">${completed} / ${config.processes.length}</div>
      </div>
      <div class="kpi orange">
        <div class="label">Retrasos</div>
        <div class="value">${delays.length}</div>
      </div>
    </div>

    <div class="section-title">${showItinerary ? 'Itinerario · Plan · Real' : 'Plan · Real'}</div>
    <table>
      <thead>
        <tr>
          <th>Proceso</th>
          ${showItinerary ? '<th>Itinerario</th>' : ''}
          <th>Plan</th>
          <th>Real</th>
          <th>Dif</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        ${allProcesses.map(proc => `
          <tr>
            <td>${proc.highlight ? '⚠️ ' : ''}${proc.name}</td>
            ${showItinerary ? `<td class=\"mono\">${proc.itinerary || '--:--'}</td>` : ''}
            <td class=\"mono\">${proc.planned || '--:--'}</td>
            <td class=\"mono\">${proc.real || '-'}</td>
            <td class=\"mono\" style=\"${proc.diff !== null ? (proc.diff > 0 ? 'color:var(--red)' : 'color:var(--secondary)') : ''}\">
              ${proc.diff !== null ? `${proc.diff > 0 ? '+' : ''}${proc.diff}'` : '-'}
            </td>
            <td>
              <span class=\"badge ${proc.inProgress && !proc.real ? 'badge-progress' : (proc.status === 'ok' ? 'badge-ok' : (proc.status === 'late' ? 'badge-late' : 'badge-plan'))}\">${proc.inProgress && !proc.real ? 'En progreso' : (proc.real && proc.diff === 0 ? 'Ejecutado' : statusText(proc.status))}</span>
            </td>
          </tr>`).join('')}
      </tbody>
    </table>

    ${delaysSorted.length ? `
      <div class=\"section-title\" style=\"color:var(--red)\">Procesos con demora</div>
      <div class=\"delays\">
        ${delaysSorted.map(proc => `
          <div class=\"delay-card ${proc.highlight ? 'crit' : ''}\">
            <div style=\"display:flex;justify-content:space-between;align-items:center;gap:8px\">
              <div>${proc.highlight ? '⚠️ ' : ''}${proc.name}</div>
              <div class=\"mono\">+${proc.diff}'</div>
            </div>
          </div>`).join('')}
      </div>
    ` : ''}
  </div>
  <div style=\"padding:10px 20px;text-align:center;font-size:11px;color:#64748b\">hecho con ♥️ por <a href=\"https://wsaico.com\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"text-decoration:underline;color:#0f172a\">wsaico</a></div>
</body></html>`;

                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `TAT_Resumen_${new Date().toISOString().slice(0,16).replace('T','_')}.html`;
                link.click();
                setTimeout(() => URL.revokeObjectURL(url), 1500);
            };

            const downloadSummaryPNG = async () => {
                const wasOpen = showSummary;
                if (!wasOpen) setShowSummary(true);
                const wait = (ms) => new Promise(r => setTimeout(r, ms));
                await wait(150);
                const el = summaryRef.current;
                if (!el || typeof html2canvas === 'undefined') return;
                const prev = { maxHeight: el.style.maxHeight, overflow: el.style.overflow, boxShadow: el.style.boxShadow };
                el.style.maxHeight = 'none';
                el.style.overflow = 'visible';
                el.style.boxShadow = 'none';
                const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
                el.style.maxHeight = prev.maxHeight;
                el.style.overflow = prev.overflow;
                el.style.boxShadow = prev.boxShadow;
                const data = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = data;
                link.download = `TAT_Resumen_${new Date().toISOString().slice(0,16).replace('T','_')}.png`;
                link.click();
                if (!wasOpen) setShowSummary(false);
            };

            return (
                <div className="min-h-screen bg-slate-50">
                    {/* Header */}
                    <div className="sticky top-0 z-50 bg-white shadow-md">
                        <div className="max-w-2xl mx-auto px-3 py-2.5">
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                    <div className="w-9 h-9 header-brand-bg rounded-lg flex items-center justify-center">
                                        <Icon type="plane" className="w-5 h-5 text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-base font-black text-slate-800">TAT Monitor</h1>
                                        <p className="text-xs text-slate-500 font-mono">{currentTime.toLocaleTimeString('es-PE', { hour12: false })}</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={generateHtmlSummary} className="px-2 h-9 btn-primary rounded-lg text-xs font-bold">Ver Resumen</button>
                                    <button onClick={downloadSummaryPNG} className="px-2 h-9 bg-slate-100 text-slate-800 border border-slate-300 rounded-lg text-xs font-bold">Descargar PNG</button>
                                    <button onClick={() => setShowItinerary(v => !v)} className={`px-2 h-9 rounded-lg text-xs font-bold border ${showItinerary ? 'btn-secondary' : 'bg-slate-100 text-slate-700 border-slate-300'}`}>
                                        {showItinerary ? 'Itinerario comercial: ON' : 'Itinerario comercial: OFF'}
                                    </button>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => setAircraftType('remolque')} className={`py-1.5 rounded-lg text-xs font-bold ${aircraftType === 'remolque' ? 'header-brand-bg text-white' : 'bg-slate-200 text-slate-700'}`}>
                                        TAT 35
                                    </button>
                                    <button onClick={() => setAircraftType('autopropulsado')} className={`py-1.5 rounded-lg text-xs font-bold ${aircraftType === 'autopropulsado' ? 'header-brand-bg text-white' : 'bg-slate-200 text-slate-700'}`}>
                                        TAT 40
                                    </button>
                            </div>

                            {/* Switch de itinerario comercial movido al header junto al botón de resumen */}

                            {worstDelay && (
                                <div className="mt-2 flex items-center gap-2 px-2 py-1 bg-red-50 border border-red-200 rounded">
                                    <Icon type="alert" className="w-4 h-4 text-red-700" />
                                    <span className="text-xs font-bold text-red-700">Fuera de tiempo +{worstDelay.diff}'</span>
                                    <span className="text-xs text-red-700">en {worstDelay.name}</span>
                                </div>
                            )}

                            {bestImprovement && (
                                <div className="mt-2 flex items-center gap-2 px-2 py-1 bg-soft-secondary border border-slate-200 rounded">
                                    <Icon type="check" className="w-4 h-4" style={{ color: 'var(--secondary)' }} />
                                    <span className="text-xs font-bold" style={{ color: 'var(--secondary)' }}>Ganando {Math.abs(bestImprovement.diff)}'</span>
                                    <span className="text-xs" style={{ color: 'var(--secondary)' }}>en {bestImprovement.name}</span>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="max-w-2xl mx-auto px-3 py-3 pb-20">
                        {/* Config Base */}
                        <div className="bg-white rounded-lg shadow-sm p-3 mb-3">
                            <div className={`grid ${showItinerary ? 'grid-cols-3' : 'grid-cols-2'} gap-3`}>
                                <div>
                                    <label className="text-xs font-bold text-slate-600 mb-1 block">Corte Motor</label>
                                    <input type="text" inputMode="numeric" placeholder="HH:MM" value={motorCutTime}
                                        onChange={(e) => setMotorCutTime(formatTimeInput(e.target.value))}
                                        pattern="^([01]\\d|2[0-3]):([0-5]\\d)$"
                                        className="w-full px-2.5 py-1.5 input-primary rounded font-mono text-sm font-bold" />
                                </div>
                                {showItinerary && (
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 mb-1 block">Corte Motor Itinerario (Comercial)</label>
                                        <input type="text" inputMode="numeric" placeholder="HH:MM" value={itineraryMotorCutTime}
                                            onChange={(e) => setItineraryMotorCutTime(formatTimeInput(e.target.value))}
                                            pattern="^([01]\\d|2[0-3]):([0-5]\\d)$"
                                            className="w-full px-2.5 py-1.5 input-primary rounded font-mono text-sm font-bold" />
                                    </div>
                                )}
                                <div>
                                    <label className="text-xs font-bold text-slate-600 mb-1 block">ETD Plan</label>
                                    <input type="text" inputMode="numeric" placeholder="HH:MM" value={etdTime}
                                        onChange={(e) => setETDTime(formatTimeInput(e.target.value))}
                                        pattern="^([01]\\d|2[0-3]):([0-5]\\d)$"
                                        className="w-full px-2.5 py-1.5 input-secondary rounded font-mono text-sm font-bold" />
                                </div>
                            </div>
                        </div>

                        {/* Métricas */}
                        <div className="grid grid-cols-3 gap-2 mb-3">
                            <div className={`rounded-lg p-2.5 ${tatCardClass}`}>
                                <div className="text-white/70 text-xs font-bold">TAT</div>
                                <div className="text-white text-xl font-black">{actualTAT !== null ? `${actualTAT}'` : `--'`}</div>
                                <div className="text-white/80 text-xs">/{tatTarget}'</div>
                            </div>
                            <div className="rounded-lg p-2.5 card-clock">
                                <div className="absolute top-1 right-1">
                                    <span className="text-[10px] font-bold badge-plan">CP {(allProcesses.find(p => p.id === 'doorsClosed')?.planned) || '--:--'}</span>
                                </div>
                                <div className="text-white/70 text-xs font-bold flex items-center justify-center gap-1 text-center">
                                    <Icon type="clock" className="w-3.5 h-3.5" /> Reloj
                                </div>
                                <div className="text-white text-xl font-black digital-clock text-center">
                                    <span className="digits">{String(currentTime.getHours()).padStart(2, '0')}</span>
                                    <span className="colon">:</span>
                                    <span className="digits">{String(currentTime.getMinutes()).padStart(2, '0')}</span>
                                </div>
                                <div className="text-white/80 text-xs text-center">hora actual</div>
                            </div>
                            <div className={`rounded-lg p-2.5 ${delays.length > 0 ? 'bg-orange-600' : 'bg-slate-600'}`}>
                                <div className="text-white/70 text-xs font-bold">Retrasos</div>
                                <div className="text-white text-xl font-black">{delays.length}</div>
                                <div className="text-white/80 text-xs">detectados</div>
                            </div>
                        </div>

                        {/* (Movido) Alertas de Retrasos se muestran al final */}

                        {/* Timeline Procesos */
                        }
                        <div className="space-y-2">
                            {allProcesses.map((proc) => {
                                const isManual = proc.id === 'motorCut' || proc.id === 'etd';
                                const statusColors = {
                                    late: 'border-l-4 border-l-red bg-soft-red',
                                    ok: 'border-l-4 border-l-secondary bg-soft-secondary',
                                    planned: 'border-slate-300 bg-white',
                                    setup: 'border-slate-300 bg-white'
                                };
                                const badgeText =
                                    proc.inProgress ? 'En progreso' :
                                    (proc.status === 'ok' ? (proc.diff === 0 ? 'Ejecutado' : 'A tiempo') :
                                     proc.status === 'planned' ? 'Planificado' :
                                     proc.status === 'setup' ? 'Planificar' :
                                     'Fuera de tiempo');
                                const badgeClass =
                                    proc.inProgress ? 'badge-progress' :
                                    (proc.status === 'ok' ? 'badge-ok' :
                                    (proc.status === 'planned' || proc.status === 'setup') ? 'badge-plan' :
                                    'badge-late');
                                
                                return (
                                    <div key={proc.id} className={`rounded-lg border-l-4 ${statusColors[proc.status]} ${proc.highlight && proc.status !== 'ok' ? 'ring-2 ring-red-300' : ''} shadow-sm ${proc.inProgress ? 'pulse' : ''}`}>
                                        <div className="p-2.5">
                                            <div>
                                                <div className="flex items-center justify-between gap-2">
                                                    <div className="flex items-center gap-2">
                                                        <h4 className="text-sm font-bold text-slate-800">{proc.name}</h4>
                                                        {proc.highlight && <span className="text-xs px-1.5 py-0.5 bg-red-600 text-white rounded font-bold">CRÍTICO</span>}
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-xs font-bold rounded-full px-2 py-0.5 ${badgeClass}`}>{badgeText}</span>
                                                        {proc.inProgress && <span className="spinner" aria-label="progreso" />}
                                                    </div>
                                                </div>
                                                {proc.inProgress && (
                                                    <div className="progress-track mt-1">
                                                        <div className="progress-indicator"></div>
                                                    </div>
                                                )}
                                                <div className="flex items-center justify-between mt-1">
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <span className="text-xs text-slate-500 font-semibold">Plan: <span className="font-mono font-bold text-slate-700">{proc.planned || '--:--'}</span></span>
                                                    {showItinerary && (
                                                        <span className="text-xs text-slate-500 font-semibold">Itin: <span className="font-mono font-bold text-slate-700">{proc.itinerary || '--:--'}</span></span>
                                                    )}
                                                    {proc.diff !== null && (
                                                        <span className={`text-xs diff-badge ${proc.diff > 0 ? 'diff-late' : 'diff-ok'}`}>
                                                            {proc.diff > 0 ? '+' : ''}{proc.diff}'
                                                        </span>
                                                    )}
                                                    <span className="minute-pill">{proc.offset}</span>
                                                </div>
                                                    {!isManual && (
                                                        <div className="flex items-center gap-2 flex-wrap justify-end">
                                                            {!proc.real ? (
                                                                <button onClick={() => captureTime(proc.id)} 
                                                                    className="px-3 py-1.5 btn-primary rounded text-xs font-bold flex items-center justify-center gap-1.5">
                                                                    <Icon type="zap" className="w-3.5 h-3.5" />
                                                                    Capturar
                                                                </button>
                                                            ) : (
                                                                <>
                                                                    <div className="px-2 py-1.5 bg-slate-100 rounded">
                                                                        <span className="text-xs text-slate-500 font-semibold">Real: </span>
                                                                        <span className="font-mono text-sm font-bold text-slate-800">{proc.real}</span>
                                                                    </div>
                                                                    <button onClick={() => setEditingId(proc.id)} className="px-2.5 py-1.5 bg-slate-300 rounded active:bg-slate-400">
                                                                        <Icon type="edit" className="w-3.5 h-3.5 text-slate-700" />
                                                                    </button>
                                                                </>
                                                            )}
                                                            {editingId === proc.id && (
                                                                <>
                                                                    <input type="text" inputMode="numeric" placeholder="HH:MM" value={realTimes[proc.id] || ''}
                                                                        onChange={(e) => setRealTimes(prev => ({ ...prev, [proc.id]: formatTimeInput(e.target.value) }))}
                                                                        pattern="^([01]\\d|2[0-3]):([0-5]\\d)$"
                                                                        className="w-24 px-2 py-1 border border-slate-300 rounded font-mono text-xs font-bold" />
                                                                    <button onClick={() => setEditingId(null)} className="px-2.5 py-1 btn-primary rounded text-xs font-bold">OK</button>
                                                                    <button onClick={() => {
                                                                        setRealTimes(prev => { const n = {...prev}; delete n[proc.id]; return n; });
                                                                        setEditingId(null);
                                                                    }} className="px-2.5 py-1 bg-red-600 text-white rounded text-xs font-bold">
                                                                        Borrar
                                                                    </button>
                                                                </>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Alertas de Retrasos (al final con scroll) */}
                        {delays.length > 0 && (
                            <div className="bg-red-50 border-l-4 border-red-600 rounded-lg p-3 mt-3">
                                <div className="flex items-center gap-2 mb-2">
                                    <Icon type="alert" className="w-4 h-4 text-red-600" />
                                    <span className="text-xs font-black text-red-900">RETRASOS DETECTADOS</span>
                                </div>
                                <div className="max-h-48 overflow-auto hide-scrollbar space-y-1.5">
                                    {delays.map((proc) => (
                                        <div key={proc.id} className={`flex justify-between items-center p-2 rounded ${proc.highlight ? 'bg-red-600 text-white' : 'bg-white'}`}>
                                            <span className={`text-xs font-bold ${proc.highlight ? 'text-white' : 'text-slate-800'}`}>
                                                {proc.highlight && '⚠️ '}{proc.name}
                                            </span>
                                            <span className={`text-sm font-black ${proc.highlight ? 'text-white' : 'text-red-600'}`}>
                                                +{proc.diff}'
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modal Resumen */}
                    {showSummary && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-auto" ref={summaryRef}>
                                <div className="p-5">
                                    <div className="text-center mb-4 pb-4 border-b-2 border-slate-200">
                                        <h2 className="text-xl font-black text-slate-800">RESUMEN TAT</h2>
                                        <p className="text-xs text-slate-500 mt-1 font-mono">{new Date().toLocaleString('es-PE', { hour12: false })}</p>
                                        <div className="flex justify-center gap-4 mt-3">
                                            <div className="text-center">
                                                <div className="text-xs text-slate-600 font-bold">Tipo</div>
                                                <div className="text-sm font-black text-slate-800">{aircraftType === 'remolque' ? 'Remolque' : 'Autopropulsado'}</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-xs text-slate-600 font-bold">TAT Real</div>
                                                <div className={`text-sm font-black ${tatDiff > 0 ? 'text-red-600' : ''}`} style={{ color: tatDiff > 0 ? '' : 'var(--secondary)' }}>
                                                    {actualTAT !== null ? `${actualTAT}'` : `--'`} / {tatTarget}'
                                                </div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-xs text-slate-600 font-bold">Cumplimiento TAT</div>
                                                <div className={`text-sm font-black ${actualTAT !== null && tatDiff > 0 ? 'text-red-600' : ''}`} style={{ color: actualTAT !== null && tatDiff > 0 ? '' : 'var(--secondary)' }}>
                                                    {actualTAT !== null ? (tatDiff > 0 ? `Fuera de tiempo +${tatDiff}'` : 'OK') : '--'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Tabla Resumen Completo */}
                                    <div className="mb-4">
                                        <h3 className="text-sm font-black text-slate-800 mb-2">ITINERARIO · PLAN · REAL</h3>
                                        <div className="border border-slate-300 rounded-lg overflow-hidden">
                                            <table className="w-full text-xs">
                                                <thead className="bg-slate-100">
                                                    <tr>
                                                        <th className="text-left p-2 font-bold text-slate-700">Proceso</th>
                                                        {showItinerary && (<th className="text-center p-2 font-bold text-slate-700">Itinerario</th>)}
                                                        <th className="text-center p-2 font-bold text-slate-700">Plan</th>
                                                        <th className="text-center p-2 font-bold text-slate-700">Real</th>
                                                        <th className="text-center p-2 font-bold text-slate-700">Dif</th>
                                                        <th className="text-center p-2 font-bold text-slate-700">Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {allProcesses.map((proc, idx) => (
                                                        <tr key={proc.id} className={idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                                            <td className="p-2 font-semibold text-slate-800">
                                                                {proc.highlight && '⚠️ '}{proc.name}
                                                            </td>
                                                            {showItinerary && (
                                                                <td className="p-2 text-center font-mono font-bold text-slate-700">{proc.itinerary || '--:--'}</td>
                                                            )}
                                                            <td className="p-2 text-center font-mono font-bold text-slate-700">{proc.planned}</td>
                                                            <td className="p-2 text-center font-mono font-bold text-slate-800">
                                                                {proc.real || '-'}
                                                            </td>
                                                            <td className="p-2 text-center font-bold">
                                                                {proc.diff !== null ? (
                                                                    <span className={proc.diff > 0 ? 'text-red-600' : ''} style={{ color: proc.diff > 0 ? '' : 'var(--secondary)' }}>
                                                                        {proc.diff > 0 ? '+' : ''}{proc.diff}'
                                                                    </span>
                                                                ) : '-'}
                                                            </td>
                                                            <td className="p-2 text-center">
                                                                {proc.inProgress && !proc.real && <span className="font-bold" style={{ color: 'var(--secondary)' }}>• En progreso</span>}
                                                                {!proc.inProgress && proc.status === 'ok' && (
                                                                    <span className="font-bold" style={{ color: 'var(--secondary)' }}>{proc.diff === 0 ? '✓ Ejecutado' : '✓ A tiempo'}</span>
                                                                )}
                                                                {proc.status === 'late' && <span className="text-red-600 font-bold">✗ Fuera de tiempo</span>}
                                                                {proc.status === 'planned' && <span className="text-slate-600 font-bold">• Planificado</span>}
                                                                {proc.status === 'setup' && <span className="text-slate-400 font-bold">○ Planificar</span>}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* Procesos con demora */}
                                    {delays.length > 0 && (
                                        <div className="mb-4">
                                            <h3 className="text-sm font-black text-red-700 mb-2">PROCESOS CON DEMORA</h3>
                                            <div className="border border-red-200 rounded-lg overflow-hidden">
                                                {delays.map((proc) => (
                                                    <div key={proc.id} className={`flex justify-between items-center p-2 ${proc.highlight ? 'bg-red-600 text-white' : 'bg-red-50 text-red-700'}`}>
                                                        <span className="text-xs font-bold">{proc.highlight ? '⚠️ ' : ''}{proc.name}</span>
                                                        <span className="text-sm font-black">+{proc.diff}'</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Resumen de Cumplimiento */}
                                    <div className="grid grid-cols-3 gap-3 mb-4">
                                        <div className="bg-green-50 border border-green-300 rounded-lg p-3 text-center">
                                            <div className="text-2xl font-black text-green-600">
                                                {allProcesses.filter(p => p.status === 'ok').length}
                                            </div>
                                            <div className="text-xs font-bold text-green-700">A Tiempo</div>
                                        </div>
                                        <div className="bg-red-50 border border-red-300 rounded-lg p-3 text-center">
                                            <div className="text-2xl font-black text-red-600">
                                                {allProcesses.filter(p => p.status === 'late').length}
                                            </div>
                                            <div className="text-xs font-bold text-red-700">Retrasados</div>
                                        </div>
                                        <div className="bg-slate-50 border border-slate-300 rounded-lg p-3 text-center">
                                            <div className="text-2xl font-black text-slate-600">
                                                {allProcesses.filter(p => p.status === 'planned' || p.status === 'setup').length}
                                            </div>
                                            <div className="text-xs font-bold text-slate-700">Pendientes</div>
                                        </div>
                                    </div>

                                    <div className="py-3 text-center text-xs text-slate-500">
                                        hecho con ♥️ por <a href="https://wsaico.com" target="_blank" rel="noopener noreferrer" className="underline">wsaico</a>
                                    </div>

                                    <button onClick={() => setShowSummary(false)} className="w-full py-2.5 bg-slate-800 text-white rounded-lg font-bold text-sm active:bg-slate-900" data-html2canvas-ignore>
                                        Cerrar Resumen
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Footer persistente de la calculadora (fuera del modal)
        // Nota: se renderiza al final del documento para no duplicar estilos.

        ReactDOM.render(
            <>
                <TATCalculator />
                <div className="mt-6 py-4 text-center text-xs text-slate-500">
                    hecho con ♥️ por <a href="https://wsaico.com" target="_blank" rel="noopener noreferrer" className="underline">wsaico</a>
                </div>
            </>,
            document.getElementById('root')
        );
    </script>
</body>
</html>
